import discord as dis
from time import sleep

client = dis.Client()

data_dict = {}
ids = [670295612016820237, 447334561496432640]

class pingsession:
    canstop = False
    amt = None
    member = None
    channel = None

    def __init__(self, member, amt, channel):
        data_dict[str(member.id)] = self
        self.amt = amt
        self.member = member
        self.channel = channel
           
    async def start(self):
         while not self.canstop:
            await self.channel.send(f'<@!{self.member.id}>')
            sleep(0.5)
   
    def stop(self):
        self.canstop = True


def getargs(message):
    return message.strip("!").split()


@client.event
async def on_ready():
    print("Ready")
    chnl = await client.fetch_channel(814482850246033457)
    thing = {"stri" : ""}
    while True:
            if len(data_dict.keys()) > 0:
                thing["stri"] = ""
                for key in data_dict.keys():
                    if data_dict[key] == -1:
                        thing["stri"] = thing["stri"] + f"<@!{str(key)}>\n"
                    else:
                        data_dict[key] -= 1
                        if data_dict[key] < 0:
                            data_dict[key] = None
                            continue
                        thing["stri"] = thing["stri"] + f"<@!{str(key)}>\n"

                await chnl.send(thing["stri"])
                sleep(0.1)



@client.event
async def on_message(message):
    if not message.content.startswith("!"): 
        return

    args = getargs(message.content)
    if not (message.author.id in ids):
        return
    if args[0] == "ping":
        recipient = args[1].strip("<").strip(">").strip("@").strip("!")
        member = await message.guild.fetch_member(recipient)

        if member:
            if member.id in data_dict.keys(): 
                data_dict[member.id] = None
                return
            try:
                amt = args[2]
                if amt.lower() == "inf":
                    data_dict[member.id] = -1
                else:
                    data_dict[member.id] = int(amt)
            except:
                pass                
        else:
            await message.channel.send("User not found") 
     
client.run("ODE0NDQ2Nzg0NDU3MDgwODcz.YDd-rQ.pOG3DQkrNOKvQMErHEIzcXI7c2c")


